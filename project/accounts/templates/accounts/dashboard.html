{% extends 'base/base.html' %}

{% block content %}
<main class="bg-gray-50 pt-24 pb-12">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 relative">

    <div id="success-alert" class="hidden absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-xl bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-md z-50" role="alert">
      <div class="flex">
        <div class="py-1"><i data-lucide="check-circle" class="h-6 w-6 text-green-500 mr-4"></i></div>
        <div>
          <p class="font-bold">Success!</p>
          <p class="text-sm">Your food donation has been listed successfully.</p>
        </div>
      </div>
    </div>
    <div id="error-alert" class="hidden absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-xl bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-md z-50" role="alert">
      <div class="flex">
        <div class="py-1"><i data-lucide="alert-triangle" class="h-6 w-6 text-red-500 mr-4"></i></div>
        <div>
          <p class="font-bold">Error</p>
          <p class="text-sm">Something went wrong. Please try listing your donation again.</p>
        </div>
      </div>
    </div>


    {% if request.user.type == "Rest" %}

    <div class="mb-8">
      <h1 class="text-4xl font-extrabold text-gray-800">Welcome back, {{ request.user.rest.name }}!</h1>
    <p id="greeting-text" class="text-lg text-gray-600 mt-2">
      Here's a summary of your donation activity.
    </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-8">
        <div>
          <a href="#" id="add-donation-button" class="w-full sm:w-auto flex items-center justify-center text-lg gap-3 bg-green-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:-translate-y-1">
            <i data-lucide="plus-circle" class="w-6 h-6"></i>
            Add New Food Donation
          </a>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Active Donations</h2>
          <div class="space-y-4">
            {% for donation in active_donations %}
            {% if donation.status == 'Clmd' %}
            <div class="p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-green-50 border-green-200">
              <div>
                <h3 class="font-bold text-lg text-gray-900"><span>{{ donation.dish }}</span> (Quantity - <span class="qty">{{ donation.qty }}</span>)</h3>
                <p class="text-sm text-gray-600">Pickup by: {{ donation.pickup_datetime }}</p>
              </div>
              <div class="text-sm text-center">
                <span class="font-semibold px-3 py-1 rounded-full bg-green-200 text-green-800">Claimed</span>
                <p class="text-gray-500 mt-1">by {{ donation.claimed_ngo }}</p>
              </div>
              <div class="flex items-center gap-2 mt-2 sm:mt-0">
                <a href="{% url 'picked_food' donation.id %}" class="text-sm text-white bg-green-500 hover:bg-green-600 rounded-md px-3 py-1">Mark Picked Up</a>
              </div>
            </div>
            {% elif donation.status == 'Ld' %}
            <div id="donation-{{ donation.id }}" class="p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div>
                <h3 class="font-bold text-lg text-gray-900"><span>{{ donation.dish }}</span> (Quantity - <span class="qty">{{ donation.qty }}</span>)</h3>
                <p class="text-sm text-gray-600">Pickup by: {{ donation.pickup_datetime }}</p>
              </div>
              <span class="font-semibold px-3 py-1 rounded-full bg-amber-100 text-amber-800">Listed</span>
              <div class="flex items-center gap-2 mt-2 sm:mt-0">
                <button data-donation-id="{{ donation.id }}" class="edit-donation-button text-sm text-gray-600 hover:text-gray-900"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                <a href="{% url 'dlt_food' donation.id %}" class="text-sm text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i></a>
              </div>
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Donation History</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Food Item</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Claimed By</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for donation in donation_history %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ donation.pickup_datetime|date }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ donation.dish }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ donation.claimed_ngo }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700">{{ donation.get_status_display }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <a href="#" class="mt-4 inline-block text-sm font-medium text-green-600 hover:text-green-500">View all donation history &rarr;</a>
        </div>
      </div>
      <div class="lg:col-span-1 space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100">
            <i data-lucide="heart-handshake" class="h-8 w-8 text-green-600"></i>
          </div>
          <h3 class="mt-4 text-4xl font-extrabold text-green-600">1,280</h3>
          <p class="mt-1 text-lg font-medium text-gray-600">Total Meals Donated</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-amber-100">
            <i data-lucide="calendar" class="h-8 w-8 text-amber-600"></i>
          </div>
          <h3 class="mt-4 text-4xl font-extrabold text-amber-600">42</h3>
          <p class="mt-1 text-lg font-medium text-gray-600">Donations This Month</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100">
            <i data-lucide="recycle" class="h-8 w-8 text-blue-600"></i>
          </div>
          <h3 class="mt-4 text-4xl font-extrabold text-blue-600">~150 kg</h3>
          <p class="mt-1 text-lg font-medium text-gray-600">Food Waste Reduced</p>
        </div>
      </div>
    </div>

    {% elif request.user.type == "NGO" %}

    <div class="mb-8">
      <h1 class="text-4xl font-extrabold text-gray-800">Welcome, {{ request.user.ngo.name }}!</h1>
      <p class="text-lg text-gray-600 mt-2">There are fresh food donations available near you. Thank you for your incredible work.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-8">

        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Available Donations Near You</h2>
          <div class="space-y-4">
            {% for donation in available_donations %}
            <div class="p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-start gap-4 hover:border-green-500 hover:bg-green-50/50 transition-all">
              <div class="flex-grow">
                <p class="text-sm font-semibold text-green-700">{{ donation.rest }}</p>
                <h3 class="font-bold text-lg text-gray-900">{{ donation.dish }}</h3>
                <p class="text-sm text-gray-600 mt-1">
                <span class="font-semibold">Quantity:</span> {{ donation.qty }}<br>
                <span class="font-semibold">Pickup by:</span> {{ donation.pickup_datetime }}
                </p>
              </div>
              <div class="flex flex-col items-start sm:items-end gap-2 flex-shrink-0">
                <p class="text-sm font-bold text-gray-700 flex items-center gap-1.5"><i data-lucide="map-pin" class="w-4 h-4 text-gray-500"></i> 2.5 km away</p>
                <a href="{% url 'claim_food' donation.id %}" class="w-full sm:w-auto text-center font-bold text-sm text-white bg-green-600 hover:bg-green-700 rounded-md px-4 py-2 transition-all">Claim</a>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Active Pickups</h2>
          <div class="space-y-4">
            {% for order in active_pickups %}
            <div class="p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-start gap-4 bg-amber-50 border-amber-200">
              <div class="flex-grow">
                <p class="text-sm font-semibold text-amber-800">{{ order.rest }}</p>
                <h3 class="font-bold text-lg text-gray-900">{{ order.dish }} (Serves {{ order.qty }})</h3>
                <p class="text-sm text-gray-600 mt-1">
                <span class="font-semibold">Pickup by:</span> {{ order.pickup_datetime }}
                </p>
              </div>
              <div class="flex items-center gap-2 mt-2 sm:mt-0 flex-shrink-0">
                <a href="{% url 'picked_food' order.id %}" class="text-sm text-white bg-amber-500 hover:bg-amber-600 rounded-md px-3 py-1">Mark as Completed</a>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="lg:col-span-1 space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100">
            <i data-lucide="shopping-basket" class="h-8 w-8 text-green-600"></i>
          </div>
          <h3 class="mt-4 text-4xl font-extrabold text-green-600">4,520</h3>
          <p class="mt-1 text-lg font-medium text-gray-600">Total Meals Received</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-amber-100">
            <i data-lucide="truck" class="h-8 w-8 text-amber-600"></i>
          </div>
          <h3 class="mt-4 text-4xl font-extrabold text-amber-600">85</h3>
          <p class="mt-1 text-lg font-medium text-gray-600">Pickups This Month</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md text-center">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100">
            <i data-lucide="building" class="h-8 w-8 text-blue-600"></i>
          </div>
          <h3 class="mt-4 text-4xl font-extrabold text-blue-600">25</h3>
          <p class="mt-1 text-lg font-medium text-gray-600">Active Restaurant Partners</p>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
</main>

<div id="add-donation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Add a New Donation</h2>
      <button id="close-modal-button" class="text-gray-400 hover:text-gray-800 transition-colors">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>
    <form id="donation-form" method="POST">
      {% csrf_token %}
      <div class="space-y-4">
        <div>
          <label for="food-name" class="block text-sm font-medium text-gray-700">Food Name</label>
          <input id="food-name" name="food-name" type="text" required placeholder="e.g., Vegetable Biryani, Dal Makhani" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
        </div>
        <div>
          <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity (Servings)</label>
          <input id="quantity" name="quantity" type="number" required placeholder="e.g., 20" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
        </div>
        <div>
          <label for="pickup-time" class="block text-sm font-medium text-gray-700">Pickup By (Date and Time)</label>
          <input id="pickup-time" name="pickup-time" type="datetime-local" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
          <p class="mt-1 text-xs text-gray-500">Select the final date and time for pickup.</p>
        </div>
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="cancel-modal-button" class="px-6 py-2 rounded-lg text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">Cancel</button>
          <button type="button" id="list-donation-button" class="px-6 py-2 rounded-lg text-sm font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors">List Donation</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>

   document.addEventListener('DOMContentLoaded', function() {
    const greetingEl = document.getElementById('greeting-text');

    if (greetingEl) {
      const now = new Date();

      // Get day name
      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const dayName = days[now.getDay()];

      // Get part of the day
      const hour = now.getHours();
      let partOfDay = "";
      if (hour < 12) partOfDay = "morning";
      else if (hour < 17) partOfDay = "afternoon";
      else partOfDay = "evening";

      // Update greeting
      greetingEl.textContent = `Here's a summary of your donation activity. It's ${dayName} ${partOfDay} â€” thank you for helping reduce food waste!`;
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();

    const successAlert = document.getElementById('success-alert');
    const errorAlert = document.getElementById('error-alert');

    function showAlert(type) {
      const alertElement = type === 'success' ? successAlert : errorAlert;
      if (alertElement) {
        alertElement.classList.remove('hidden');
        setTimeout(() => {
          alertElement.classList.add('hidden');
        }, 5000);
      }
    }

    const addDonationButton = document.getElementById('add-donation-button');
    const editDonationButtons = document.querySelectorAll('.edit-donation-button');
    const addDonationModal = document.getElementById('add-donation-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalButton = document.getElementById('close-modal-button');
    const cancelModalButton = document.getElementById('cancel-modal-button');
    const listDonationButton = document.getElementById('list-donation-button');
    const donationForm = document.getElementById('donation-form');
    const pickupTimeInput = document.getElementById('pickup-time');


    function toCustomISOString(year, month, day, hour, minute = 0) {
      const d = new Date(year, month - 1, day, hour, minute);
      const pad2 = (n) => n.toString().padStart(2, "0");

      const YYYY = d.getFullYear();
      const MM = pad2(d.getMonth() + 1);
      const DD = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mm = pad2(d.getMinutes());

      return `${YYYY}-${MM}-${DD}T${hh}:${mm}`;
    }

    const formatTime = (str) => {
      const parsed = new Date(str);
      if (isNaN(parsed)) {
        const parts = str
          .replace(/\./g, "")
          .replace("pm", "PM")
          .replace("am", "AM")
          .split(/[\s,]+/);
        const monthNames = {
          Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
          Jul: 7, Aug: 8, Sept: 9, Sep: 9, Oct: 10, Nov: 11, Dec: 12
        };
        const m = monthNames[parts[0]];
        const d = parseInt(parts[1], 10);
        const y = parseInt(parts[2], 10);
        let h = parseInt(parts[3], 10);
        const ampm = parts[4];
        if (ampm === "PM" && h < 12) h += 12;
        if (ampm === "AM" && h === 12) h = 0;
        return toCustomISOString(y, m, d, h, 0)
      } else {
        const Y = parsed.getFullYear();
        const M = (parsed.getMonth() + 1).toString().padStart(2, "0");
        const D = parsed.getDate().toString().padStart(2, "0");
        const h = parsed.getHours().toString().padStart(2, "0");
        const mi = parsed.getMinutes().toString().padStart(2, "0");
        return `${Y}-${M}-${D}T${h}:${mi}`
      }
    }

    const setPickupTime = (value = null) => {
      if (value === null) {
        if (pickupTimeInput) {
          const now = new Date();
          now.setHours(now.getHours()+1, 0, 0, 0);

          const year = now.getFullYear();
          const month = (now.getMonth() + 1).toString().padStart(2, '0');
          const day = now.getDate().toString().padStart(2, '0');
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');

          const defaultValue = `${year}-${month}-${day}T${hours}:${minutes}`;
          pickupTimeInput.value = defaultValue;
        }
      }
      else {
        console.log(value)
        pickupTimeInput.value = value;
      }
    }

    const openModal = () => {
      if (addDonationModal) {
        addDonationModal.classList.remove('hidden');
        setTimeout(() => {
          addDonationModal.classList.remove('opacity-0');
          modalContent.classList.remove('scale-95', 'opacity-0');
        }, 10);
      }
    };

    const closeModal = () => {
      if (addDonationModal) {
        addDonationModal.classList.add('opacity-0');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          addDonationModal.classList.add('hidden');
        }, 300);
        location.reload()
      }
    };

    if (addDonationButton) {
      addDonationButton.addEventListener('click', (e) => {
        e.preventDefault();
        openModal();
        document.getElementById('food-name').value = '';
        document.getElementById('quantity').value = '';
        setPickupTime()
      });
    }

    if (closeModalButton) closeModalButton.addEventListener('click', closeModal);
    if (cancelModalButton) cancelModalButton.addEventListener('click', closeModal);

    if (addDonationModal) {
      addDonationModal.addEventListener('click', (event) => {
        if (event.target === addDonationModal) {
          closeModal();
        }
      });
    }

    editDonationButtons.forEach((button) => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        openModal();

        const donationId = button.getAttribute('data-donation-id')
        const donationParent = document.getElementById(`donation-${donationId}`)
        document.getElementById('food-name').value = donationParent.querySelector('h3 span').textContent
        document.getElementById('quantity').value = donationParent.querySelector('h3 span.qty').textContent
        setPickupTime(formatTime(donationParent.querySelector('p').textContent.split("Pickup by: ")[1]))
      })
    })

    function sendPostRequestXHR(url, data, callback) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('X-CSRFToken', data.csrfmiddlewaretoken);

      const encodedData = new URLSearchParams(Object.entries(data)).toString();

      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          callback(null, xhr.responseText);
        } else {
          callback(new Error(`Request failed with status ${xhr.status}`), null);
        }
      };

      xhr.onerror = function() {
        callback(new Error('Network error'), null);
      };

      xhr.send(encodedData);
    }

    if(listDonationButton) {
      listDonationButton.addEventListener("click", () => {
        const csrf = donationForm.querySelector("input[name='csrfmiddlewaretoken']").value;
        const dish = document.getElementById('food-name').value;
        const quantity = document.getElementById('quantity').value;
        const pickup_time = document.getElementById('pickup-time').value;

        if (!dish || !quantity || !pickup_time) {
          showAlert('error');
          return;
        }

        const postData = {
          'dish': dish,
          'quantity': parseInt(quantity),
          'pickup_time': pickup_time,
          'csrfmiddlewaretoken': csrf
        };

        sendPostRequestXHR('/list_food_donation/', postData, (err, response) => {
          if (err) {
            console.error(err);
            showAlert('error');
          } else {
            showAlert('success');
            donationForm.reset();
          }
        });
      });
    }

    setPickupTime();
  });
</script>
{% endblock scripts %}

